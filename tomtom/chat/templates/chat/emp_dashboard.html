<!DOCTYPE html>
<html>
<head>
    <title>Employee Chat</title>
</head>
<body>
    <center><h1>Hello, {{ user.username }}!</h1></center>
    <br>
    {% if user.is_authenticated %}
        <center><a href="{% url 'logout' %}">Logout</a></center>
    {% endif %}
    <div id="chat_container" style="font-size: 20px">
        <input type="text" id="message_input" placeholder="Type your message" />
        <button type="submit" id="send_button">Send Message</button>
        <button id="call_button">Call Admin</button>
        <button id="end_call_button" style="display:none; color:red;">End Call</button>
        <button id="mute_button" style="display:none;">Mute</button>
        <br /><br />
        <div id="message_list"></div>
        <audio id="remote_audio" controls autoplay></audio>
    </div>
    <script>
        const chatSocket = new WebSocket(
            "ws://" + window.location.host + "/ws/chat/"
        );

        chatSocket.onopen = function(e) {
            console.log("Connection established.");
        };

        chatSocket.onclose = function(e) {
            console.error("WebSocket closed unexpectedly:", e);
        };

        chatSocket.onerror = function(e) {
            console.error("WebSocket error observed:", e);
        };

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log("Message received:", data);
            if (data.type === 'chat') {
                const div = document.createElement("div");
                div.innerHTML = data.username + ": " + data.message;
                document.querySelector("#message_list").appendChild(div);
            } else if (data.type === 'call') {
                handleCallSignal(data.signal, data.username);
            } else if (data.type === 'call_state') {
                handleCallState(data.state);
            }
        };

        document.querySelector("#send_button").onclick = function(e) {
            const messageInput = document.querySelector("#message_input");
            const message = messageInput.value;

            if (message.trim() !== "") {
                chatSocket.send(JSON.stringify({
                    "type": "chat",
                    "message": message,
                    "recipient": "admin"
                }));

                const div = document.createElement("div");
                div.innerHTML = "You: " + message;
                document.querySelector("#message_list").appendChild(div);

                messageInput.value = "";
            }
        };

        document.querySelector("#call_button").onclick = function(e) {
            startCall();
        };

        document.querySelector("#end_call_button").onclick = function(e) {
            endCall();
        };

        document.querySelector("#mute_button").onclick = function(e) {
            toggleMute();
        };

        let peerConnection;
        let localStream;
        let remoteStream;
        const config = {
            'iceServers': [{'urls': 'stun:stun.l.google.com:19302'}]
        };

        function startCall() {
            console.log("Starting call...");
            navigator.mediaDevices.getUserMedia({audio: true}).then(stream => {
                localStream = stream;
                peerConnection = new RTCPeerConnection(config);
                peerConnection.onicecandidate = function(event) {
                    if (event.candidate) {
                        chatSocket.send(JSON.stringify({
                            'type': 'call',
                            'signal': {'candidate': event.candidate},
                            'recipient': 'admin'
                        }));
                    }
                };

                peerConnection.ontrack = function(event) {
                    const remoteAudio = document.getElementById('remote_audio');
                    if (!remoteStream) {
                        remoteStream = new MediaStream();
                    }
                    remoteStream.addTrack(event.track);
                    remoteAudio.srcObject = remoteStream;
                };

                stream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, stream);
                });

                peerConnection.createOffer().then(offer => {
                    peerConnection.setLocalDescription(offer);
                    chatSocket.send(JSON.stringify({
                        'type': 'call',
                        'signal': {'sdp': offer},
                        'recipient': 'admin'
                    }));
                });

                document.querySelector("#end_call_button").style.display = "block";
                document.querySelector("#mute_button").style.display = "block";

                chatSocket.send(JSON.stringify({
                    'type': 'call_state',
                    'state': 'ringing',
                    'recipient': 'admin'
                }));
            }).catch(error => {
                console.error("Error accessing microphone:", error);
                alert("Microphone access is required to make a call. Please allow access.");
            });
        }

        function endCall() {
            console.log("Ending call...");
            chatSocket.send(JSON.stringify({
                'type': 'call_state',
                'state': 'ended',
                'recipient': 'admin'
            }));
            if (peerConnection) {
                peerConnection.close();
            }
            document.querySelector("#end_call_button").style.display = "none";
            document.querySelector("#mute_button").style.display = "none";
        }

        function toggleMute() {
            console.log("Toggling mute...");
            const audioTrack = localStream.getAudioTracks()[0];
            audioTrack.enabled = !audioTrack.enabled;
            document.querySelector("#mute_button").innerText = audioTrack.enabled ? "Mute" : "Unmute";
        }

        function handleCallSignal(signal, username) {
            console.log("Handling call signal from", username);
            if (signal.sdp) {
                peerConnection.setRemoteDescription(new RTCSessionDescription(signal.sdp));
                if (signal.sdp.type === 'offer') {
                    peerConnection.createAnswer().then(answer => {
                        peerConnection.setLocalDescription(answer);
                        chatSocket.send(JSON.stringify({
                            'type': 'call',
                            'signal': {'sdp': answer},
                            'recipient': username
                        }));
                    });
                }
            } else if (signal.candidate) {
                peerConnection.addIceCandidate(new RTCIceCandidate(signal.candidate));
            }
        }

        function handleCallState(state) {
            console.log("Handling call state:", state);
            if (state === 'accepted') {
                console.log("Call accepted");
            } else if (state === 'ended') {
                console.log("Call ended");
                if (peerConnection) {
                    peerConnection.close();
                }
                document.querySelector("#end_call_button").style.display = "none";
                document.querySelector("#mute_button").style.display = "none";
            } else if (state === 'ringing') {
                console.log("Ringing the admin...");
            }
        }
    </script>
</body>
</html>
